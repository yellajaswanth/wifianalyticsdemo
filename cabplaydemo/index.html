<html>
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Cabplay Dashboard</title>
      <meta name="description" content="">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
      <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
      <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">
      <!-- needs images, font... therefore can not be part of ui.css -->
      <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
      <link rel="stylesheet" href="bower_components/weather-icons/css/weather-icons.min.css">
      <!-- end needs images -->
      <link rel="stylesheet" type="text/css" href="css/ag-grid.css">
      <link rel="stylesheet" type="text/css" href="css/theme-fresh.css">
      <link rel="stylesheet" href="styles/main.css">
      <!-- Optional theme -->
      <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css">
      <!-- Tabs Css-->
      <!-- Tabs Css-->
      <style type="text/css">
          #sessiontable td{
            cursor: pointer;
          }

      </style>
   </head>
   <body ng-app="app" id="app" ng-controller="AppCtrl">
      <div  data-ng-cloak="" data-ng-hide="isSpecificPage()">
         <section data-ng-include=" 'views/header.html' " id="header" class="top-header"></section>
         <aside data-ng-include=" 'views/nav.html' " id="nav-container"></aside>
      </div>
      <div class="view-container">
         <section data-ng-view="" id="content"></section>
      </div>
      <!-- Google Maps JS Start-->     
      <script src="https://maps.googleapis.com/maps/api/js"></script>    
      <!-- Google Maps JS End-->         
      <script src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
      <script src="scripts/firebase.js"></script>
      <script src="scripts/vendor.js"></script>
      <!-- Google Maps JS Start-->         
      <script src="http://dylanfprice.github.io/angular-gm/1.0.0/angular-gm.js"></script>    
      <!-- Google Maps JS End-->    
      <script src="scripts/ui.js"></script>
      <script src="scripts/ag-grid.js"></script>
      <!-- Tabs JS-->
      <script src="scripts/maplace-0.1.3.js"></script>     
      <script src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>

      <script src="http://momentjs.com/downloads/moment.js"></script>

      <!-- Tabs JS-->    
      <script type="text/javascript">

      
         Parse.initialize("wK0yUEQAhOZWJLZFcNrH9TsOWKdJ1R3Yrz5rFyuS", "zlP1nJRLNbM2CPm4O0HssVYgOqROJxUUZsR3mUfO");
         var module = angular.module("app", ["ngRoute","agGrid","AngularGM","ui.bootstrap"]);
         module.config(["$routeProvider", function($routeProvider) {
             return $routeProvider.when("/", {
                 redirectTo: "/dashboard"
             }).when("/dashboard", {
                 templateUrl: "views/dashboard.html"
             }).when("/footfall", {
                 templateUrl: "views/users.html"
             }).when("/advertising", {
                 templateUrl: "views/addcampaign.html"
            }).when("/users", {
                templateUrl: "views/users.html"
             }).when("/profile/:macaddress", {
             	templateUrl: "views/profile.html"             
             }).otherwise({
                 redirectTo: "/404"
             })
         }]).run(function($rootScope,$location) {    
             $rootScope.$on("$locationChangeStart",function(event, next, current){
                 console.log($location.path());
                 
                 if(Parse.User.current()) { 
                     $('body').removeClass("body-special");
                   var UserData = Parse.User.current();
                   $rootScope.UserName = UserData.attributes.username;
                   console.log("User already logged in");                      
                 } else {     
                     $('body').addClass("body-special");
                     console.log("User already logout");                                                    
                   $location.path("signin");           
                 }
             }) ;   
         })            
         module.controller("loginCtrl", ["$scope","$location","$timeout","$rootScope", function($scope,$location,$timeout,$rootScope) {
              $scope.loginSubmit = function(loginfrm){
                $scope.login_submit = true;
                  if(loginfrm.$valid){ 
                    if(($scope.login.username != '') && ($scope.login.password != '')) {
         
                      // Get data from the form and put them into variables
                      var username = $scope.login.username;
                      var password = $scope.login.password;
         
                      // Call Parse Login function with those variables
                      Parse.User.logIn(username, password, {
                      // If the username and password matches
                      success: function(user) {
                        $timeout(function() {
                           $location.path("/dashboard");
                        }, 1000);                 
                      },
                      // If there is an error
                      error: function(user, error) {
                      $scope.$apply(function(){
                        $scope.invalidShow = true;                 
                        $scope.invalid1 = error.message;                            
                        console.log(error);
                        });
                      }
                      });
                  }           
               }
           }   
         }]);

        module.factory("tableMinimize", function(){
            $('.tableMinMax').click(function(){
                  if($(this).hasClass('minimize')){
                    $(this).parent('.panel-heading').parent('.panel').find('.dataTables_wrapper').hide();
                    $(this).empty();
                    $(this).append('<i class="fa fa-plus"></i>');
                    $(this).removeClass('minimize');
                    $(this).addClass('maximize');
                  } else {
                    $(this).parent('.panel-heading').parent('.panel').find('.dataTables_wrapper').show();
                    $(this).empty();
                    $(this).append('<i class="fa fa-minus"></i>');
                    $(this).removeClass('maximize');
                    $(this).addClass('minimize');
              }
            });
        });

         module.controller("AppCtrl", function($scope, $http,$location) {
         
             return $scope.isSpecificPage = function() {
                 var path;
                 return path = $location.path(), _.contains(["/signin"], path)
             }, $scope.main = {
                 brand: "Cabplay",
                 name: "Jash"
             }
           
         }).directive("logoutUser", ["$timeout", function($timeout) {
             return {
                 restrict: "A",
                 link: function(scope, element) {
                    
                   element.bind('click', goBack);     
                   function goBack(){
                     console.log("Performing logout");
                     //logout current user
                     if(Parse.User.current()) {
                       Parse.User.logOut();
                           console.log("User going to logout");                      
                         // check if really logged out
                         if(Parse.User.current()) {
                           console.log("Failed to log out!");
                         }
                    //$timeout(function() {
                       //$location.path('/');
                       window.location.href = "http://cabplay.com/cabdemo/#/pages/signin";                      
                    //}, 2000);  
                    } else {    
                    console.log("User already logout");                                                                    
                    }
                   }            
                 }
             }
         }]);
         
          module.controller("DashboardCtrl", function($scope, tableMinimize) {

          	var olaPilot = new Firebase("https://resplendent-inferno-6735.firebaseio.com/hotspotsession");
          	olaPilot.once('value', function(snapshot){
          		$scope.olapilotdata = [];

				      $scope.totalduration = 0;

          		$.each(snapshot.val(), function(index, element) {


	          		
	          		var createdTS = index.split("_");
	          		var date1 = new Date(createdTS[0]*1000);
	          		var date2 = new Date(element.updatedAt);
	          		// console.log(element.username + date1 + " - " + date2);
	          		var diff = date2.getTime() - date1.getTime();

      					var msec = diff;
      					$scope.totalduration = diff + $scope.totalduration ;
      					var hh = Math.floor(msec / 1000 / 60 / 60);
      					msec -= hh * 1000 * 60 * 60;
      					var mm = Math.floor(msec / 1000 / 60);
      					msec -= mm * 1000 * 60;
      					var ss = Math.floor(msec / 1000);
      					msec -= ss * 1000;

					// console.log("Duration:" + hh + ":" + mm + ":" + ss);
          var duration = "";
          if(hh!=null){

					   duration =  hh + ":" + mm + ":" + ss;
           }

           if (date2 !=null){

          date2 = date2.toString();
        } else {
          date2 = "";
        }

        var dataconsumed = parseInt(element.downloaded,10) + parseInt(element.uploaded, 10);

        dataconsumed = parseInt(dataconsumed/1024/1024, 10);

        dataconsumed = dataconsumed + " MB";

					var username = replaceall('_',' ', element.username);

	          		$scope.olapilotdata.push({
	          			"hotspotname":element.hotspotname,
	          			"username"	: username,
	          			"macaddress":element.macaddress,
	          			"email"		:element.email,
	          			"devicetype":element.devicetype,
	          			"dataconsumed":dataconsumed,
	          			"duration"	: duration,
                  "updatedAt" : date2
	          		});               

				}); 

    

    $scope.olapilotdata.reverse();

				var msec = $scope.totalduration;
				
				var hh = Math.floor(msec / 1000 / 60 / 60);
				msec -= hh * 1000 * 60 * 60;
				var mm = Math.floor(msec / 1000 / 60);
				msec -= mm * 1000 * 60;
				var ss = Math.floor(msec / 1000);
				msec -= ss * 1000;
				
				$scope.totalduration =  hh + ":" + mm + ":" + ss;

				$('#sessiontable').DataTable( {
			        data: $scope.olapilotdata,
			        columns: [
			            {title:"BSSID", data: "hotspotname" },
			            {title:"USERNAME",  data: "username" },
			            {title:"MACADDRESS",  data: "macaddress" },
			            {title:"EMAIL",  data: "email" },
			            {title:"USAGE",  data: "dataconsumed" },
			            {title:"DURATION",  data: "duration"},
			            {title:"UPDATEDAT",  data: "updatedAt"}
			        ]
			    } );

         

          		$scope.$apply();
          	});	

          	var cabplayUsers = new Firebase("https://resplendent-inferno-6735.firebaseio.com/users");

			cabplayUsers.on('value', function(snapshot){
	      		$scope.cabplayUsers = snapshot.val();
	      		var count = 0;

	      		$.each(snapshot.val(), function(index, element) {
	          		count ++;
				}); 

             $("#sessiontable").on("click", "tr", function() {       
             if (!($(this).find('th').hasClass('sorting') || $(this).find('th').hasClass('sorting_desc') || $(this).find('th').hasClass('sorting_asc'))){
                window.location.href = 'http://www.cabplay.com/cabplaydemo/#/profile/' + $(this).find('td:nth-child(3)').text();
             }
          });

	      		$scope.usercount = count;
				$scope.$apply();
          	});

          	var replaceall = function (find, replace, str) 
      		    {
      		      while( str.indexOf(find) > -1)
      		      {
      		        str = str.replace(find, replace);
      		      }
      		      return str;
      		    }

          var hotspots = new Firebase("https://resplendent-inferno-6735.firebaseio.com/hotspotsession");
          hotspots.on('value', function(snapshot){
              $scope.hotspotcount = 1;
              $scope.hotspotdata = 0;
              $.each(snapshot.val(), function(index, element) {
                if(element.downloaded != null && element.uploaded != null){
                  $scope.hotspotdata = parseInt(element.downloaded,10) + parseInt(element.uploaded,10) + $scope.hotspotdata;
                }
              });


              if($scope.hotspotdata/1024/1024/1024 > 1){
                $scope.hotspotdata = parseInt($scope.hotspotdata/1024/1024/1024,10) + " GB";
              } else if($scope.hotspotdata/1024/1024 > 1){
                $scope.hotspotdata = parseInt($scope.hotspotdata/1024/1024,10) + " MB";
              }                

              $scope.$apply();
          });

          var inbrowser = new Firebase("https://resplendent-inferno-6735.firebaseio.com/inbrowser");
          inbrowser.child('OlaAd').child('defaultAd').once('value', function(snapshot){
            console.log(snapshot.val());

            $scope.ads = [];

            $scope.ads.push(snapshot.val());

                $('#adcampaigns').DataTable( {
              data: $scope.ads,
              columns: [
                  {title:"CampaignName",  data: "campaignName" },
                  {title:"AdType", data: "adtype" },
                  {title:"Impressions",  data: "impressions" },
                  {title:"ClickThroughs",  data: "clickthrough" }
              ]
          } );

                $scope.$apply();

          }); 


    }); 

  


    module.controller('UserCtrl', function ($rootScope, $scope, $routeParams, $route, $http) {        

        var footfallRef = new Firebase("https://resplendent-inferno-6735.firebaseio.com/footfall");
        footfallRef.once('value', function(snapshot){

          $scope.footfall = [];
          $.each(snapshot.val(), function(index, element){
              $.each(element, function(key, val){
                var data = {};
                var timestamp = convertTime(val.updatedAt);
                data =  {
                    "macaddress" : val.macaddress,
                    "hotspot"      : val.bssid,
                    "signal"      : val.rssi,
                    "timestamp"   : timestamp
                  };
                  $scope.footfall.push(data);                
              });
          });   


        $('#footfalltable').DataTable( {
              data: $scope.footfall,
              columns: [
                  {title:"BSSID", data: "hotspot" },
                  {title:"MACADDRESS",  data: "macaddress" },
                  {title:"SIGNAL",  data: "signal"},
                  {title:"UPDATEDAT",  data: "timestamp"}
              ]
          } );

         $("#footfalltable").on("click", "tr", function() {       
             if (!($(this).find('th').hasClass('sorting') || $(this).find('th').hasClass('sorting_desc') || $(this).find('th').hasClass('sorting_asc'))){
                window.location.href = 'http://www.cabplay.com/cabplaydemo/#/profile/' + $(this).find('td:nth-child(2)').text();
             }
          });

          console.log($scope.footfall);

          $scope.$apply();
        });

        var convertTime = function (time) {        
            var duration = moment(time).format('MMMM Do YYYY, h:mm:ss a');
            return duration;
        };

        var numberFormat = function(num){
            var length = num.toString().length;
            if(length == 1){
              num = "0"+num;
            }

            return num;
        };
    });
  
  
		module.controller('ProfileCtrl', function ($rootScope, $scope, $routeParams, $route, $http,tableMinimize) {    
			

			$scope.macaddress = $routeParams.macaddress;

			$scope.oladata = [];

			var olaPilot = new Firebase("https://resplendent-inferno-6735.firebaseio.com/users");

	       olaPilot.child($scope.macaddress).once('value', function(snapshot){
	       		$scope.oladata.push(snapshot.val());
	       		$scope.usagecount = $scope.oladata.length;
	       		$scope.username = snapshot.val().username;
	       		$scope.datausage = parseInt(snapshot.val().downloaded,10) + parseInt(snapshot.val().uploaded,10);
	       		$scope.email = snapshot.val().email;
	       		$scope.mobile = snapshot.val().mobile;
	       		$scope.fbid = snapshot.val().fbid;
	       		$scope.block = snapshot.val().block;
	       		$scope.gender = snapshot.val().gender;
	       		if(snapshot.val().fbid != null){
	       			$scope.fbconnect = "Connected";
	       		} else{
	       			$scope.fbconnect = "Not Connected";
	       		}
	       		$scope.$apply();
	       });

	       var hotspotsession = new Firebase("https://resplendent-inferno-6735.firebaseio.com/hotspotsession");
         var browsinghistory = new Firebase("https://resplendent-inferno-6735.firebaseio.com/browsinghistory");

	       hotspotsession.once('value', function(snapshot){

	       		$scope.newoladata = [];

	       		$.each(snapshot.val(), function(index, element) {
	       			var usermacadd = index.split("_");
	       			if($scope.macaddress === usermacadd[1]){
	       				$scope.newoladata.push(element);
                $scope.email = element.email;
	       			}
	       		});	

            

            $.each(snapshot.val(), function(index, element) {
              if($scope.email === element.email && $scope.macaddress != element.macaddress){
                $scope.newoladata.push(element);
              }
            }); 

            $scope.devicesarr = [];

             $.each($scope.newoladata, function(index, element) {
              if($.inArray(element.macaddress, $scope.devicesarr) < 0){
                $scope.devicesarr.push(element.macaddress);
              }
            }); 


            $scope.devicescount = $scope.devicesarr.length;

	       		// console.log($scope.newoladata);

            $scope.newoladata.reverse();

            $scope.wificonnectcount = $scope.newoladata.length;

	       		$scope.$apply();

	       });


      browsinghistory.child($scope.macaddress).once('value', function(snapshot){

				$scope.browsingdata = [];
            $.each(snapshot.val(), function(index, element) {
        			$scope.browsingdata.push(element);
        		}); 

            $scope.browsingdata.reverse();


              $('#historytable').DataTable( {
			        data: $scope.browsingdata,
			        columns: [
			            {title:"BSSID", data: "bssid" },
			            {title:"MACADDRESS",  data: "macaddress" },
			            {title:"EMAIL",  data: "url" }
			        ]
			    });

              console.log($scope.browsingdata);
              $scope.$apply();
          });
          
	    });

      module.controller('AddCampaignCtrl', function ($rootScope, $scope, $routeParams, $route, $http) {    

          $scope.adtype = 'bottomad';

          var inbrowser = new Firebase("https://resplendent-inferno-6735.firebaseio.com/inbrowser");

          var insertString = function(str, index, value) {
              return str.substr(0, index) + value + str.substr(index);
          }
            
          $scope.submitcampaign = function(){

              console.log($scope.campaignName + $scope.adtype + $scope.iconurl + $scope.bannerurl + $scope.navurl);

              if($scope.adtype === 'bottomad'){

                  var data = {
                    campaignName: $scope.campaignName,
                    adtype: $scope.adtype,
                    iconurl: $scope.iconurl, 
                    bannerurl: $scope.bannerurl,
                    navurl: $scope.navurl,
                    impressions: 0,
                    clickthrough: 0
                  };
                } else if($scope.adtype === 'videoad'){

                    var youtube  = 'https://www.youtube.com/watch?v=';
                    var embedyoutube = 'https://www.youtube.com/embed/'
                    var embedparams = '?&autoplay=1&rel=0&hd=1&autohide=1';
                    var newurl   = $scope.videourl.replace(youtube, '');
                    newurl = insertString(newurl, 0, embedyoutube);
                    newurl = insertString(newurl, newurl.length, embedparams);

                    $scope.videourl = newurl;

                     var data = {
                        campaignName: $scope.campaignName,
                        adtype: $scope.adtype,
                        videourl: $scope.videourl,
                        impressions: 0,
                        clickthrough: 0
                     };
                }

              inbrowser.child('OlaAd').child('defaultAd').set(data);

              inbrowser.child('OlaAd').child('defaultAd').child('createdAt').set(Firebase.ServerValue.TIMESTAMP);
              inbrowser.child('OlaAd').child('defaultAd').child('updatedAt').set(Firebase.ServerValue.TIMESTAMP);

              alert($scope.adtype + ' Campaign Created');

          };  

      });
         
      </script>
   </body>
</html>